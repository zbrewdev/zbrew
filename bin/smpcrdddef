#!/bin/sh
#set -x

out=$(whence zbrewfuncs >/dev/null)
if [ $? -eq 0 ]; then
	. zbrewfuncs
else
	echo "zbrew tools need to be in your PATH" >&2
	exit 4
fi

InvalidOption=1
TooFewParms=2
UnknownAction=3
PrefixTooLong=4

#
# Temporary hack - replace with a proper message file
#
msg() {
        pgm=$1
        msgnum=$2
        msgtype=$3

        shift 3
        args=$*

        case ${msgnum} in
                ${InvalidOption}) msgtext="Invalid option specified: -";;
                ${TooFewParms}) msgtext="Too few Parameters specified. Expected 2 but received: ";;
                ${UnknownAction}) msgtext="Unknown action specified: ";;
                ${PrefixTooLong}) msgtext="Prefix must be 6 characters or less. Received: ";;
                *) msgtext="Internal Error. Unknow msgnum: ${msgnum}";;
        esac
        echo "ZCL000"${msgnum}${msgtype} "${msgtext}${args}" >&2
}



#for All but ZFS libraries
targ_dddefs(){
libs=`readbom ${zosname} <${smpelibs}`
rc=$?
if [ $rc -gt 0 ]; then
  echo $libs >&2
  exit $rc
fi

targdddefs=`echo "${libs}" | awk '($2 != "ZFS" && $7 == "T") {print $1}'` 
for targdddef in ${targdddefs}; do
 smpuclin="${smpuclin}
 REP DDDEF(${targdddef})
 DA(${ZBREW_HLQ}${zosname}.${targdddef})
 UNIT(SYSALLDA)
 WAITFORDSN
 SHR.
"
done

#for ZFS 
targdddefs=`echo "${libs}" | awk '($2 == "ZFS" && $5 == "T") {print $1","$6}'`
for targddzfs in ${targdddefs}; do
 targdddef=`echo "${targddzfs}" | awk -F, '{print $1}'`
 dddefpath=`echo "${targddzfs}" | awk -F, '{print $2}'`
 smpuclin="${smpuclin}
 REP DDDEF(${targdddef})
 PATH('${ZFSROOT}${ZFSDIR}${dddefpath}').
"
done


#for CALLLIBS 
for targdddef in ${CALLLIBS}; do
 llq=`echo ${targdddef} | awk -F'.' '{print $2}'`
 smpuclin="${smpuclin}
  REP DDDEF(${llq})
  DA(${targdddef})
  UNIT(SYSALLDA)
  WAITFORDSN
  SHR.
"
done
}

dist_dddefs(){
libs=`readbom ${zosname} <${smpelibs}`
rc=$?
if [ $rc -gt 0 ]; then
  exit $rc
fi
distdddefs=`echo "${libs}" | awk '($7 == "D") {print $1}'`
for distdddef in ${distdddefs};do
 smpuclin="${smpuclin}
 REP DDDEF(${distdddef})
 DA(${ZBREW_HLQ}${zosname}.${distdddef})
 UNIT(SYSALLDA)
 WAITFORDSN
 SHR.
"

done
}


run_gimsmp(){
mvscmdauth --pgm=GIMSMP --smpcsi=${ZBREW_HLQ}${zosname}G.GLOBAL.CSI --sysprint=DUMMY --smprpt=DUMMY --smplist=DUMMY --smpcntl=stdin <<zzz
${smpuclin}
zzz
        rc=$?
        if [ $rc -gt 4 ]; then
		echo "GIMSMP failed with rc:$rc" >&2
		echo "${smpuclin}" >&2
                exit $rc
        fi


}

while getopts ":vd" opt; do
  case ${opt} in
    d )
      debug=1
      ;;
    v )
      verbose=1
      opts="-v"
      ;;
    \?)
      if [ ${OPTARG} != "?" ]; then
        msg smpconfig ${InvalidOption} E "${OPTARG}"
      fi
      syntax
      exit 4
      ;;
  esac
done
shift $(expr $OPTIND - 1 )
if [ $# -lt 1 ]; then
        msg smpconfig ${TooFewParms} E "$#"
        syntax
        exit 16
fi

mydir=$(callerdir ${0})

sw=$1
ussname=$(echo ${sw} | tr '[:upper:]' '[:lower:]');
zosname=$(echo ${sw} | tr '[:lower:]' '[:upper:]');
prefix=`echo "${ussname}" | awk '{ print substr($1, 0, 3) }'`

props="${mydir}/../../zbrew/properties/zbrewprops.json"
zbrewpropse zbrew config "${props}"

props=$(callerdir "$0")"/../../zbrew/properties/globalprops.json"
zbrewpropse zbrew global ${props}

props="${mydir}/../../zbrew-${prefix}/${ussname}/${ussname}install.json"
zbrewpropse "${zosname}" install "${props}"

smpelibs="${mydir}/../../zbrew-${prefix}/${ussname}/${ussname}bom.json"


# Update Target Zone DDDEFS, note Target Zone contains both Targ/Dist libraries
smpuclin="  SET   BDY(${zosname}T).
     UCLIN.
"
targ_dddefs
dist_dddefs
 
smpuclin="${smpuclin} 
     ENDUCL."
run_gimsmp



# Update Distribution Zone DDDEFS
smpuclin="  SET BDY(${zosname}D).
     UCLIN.
"
dist_dddefs
smpuclin="${smpuclin}
     ENDUCL."
run_gimsmp


exit 0
